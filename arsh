#!/bin/dash

#  _     _          
# | |   | |           Henrique Borges (henriquehbr)
# | |__ | |__  _ __   https://github.com/henriquehbr
# | '_ \| '_ \| '__|  https://henriquehbr.dev
# | | | | |_) | |     https://reddit.com/u/henriquehbr
# |_| |_|_.__/|_|

# Exit on error
set -e

# ========== Configuration variables ==========

ROOT_PASSWORD=""
USER_NAME=""
USER_PASSWORD=""
LUKS_PARTITION_NAME=""
LUKS_PARTITION_PASSWORD=""
KEYMAP=""
LOCALE=""
MIRROR_COUNTRY=""

# ========== DO NOT EDIT BELOW THIS LINE ==========

bold=$(tput bold)
normal=$(tput sgr0)

cpu_vendor=$(lscpu | grep GenuineIntel > /dev/null 2>&1 && echo intel || echo amd)
cpu_package="${cpu_vendor}-ucode"

# Calculate swap size based on the formula: RAM + round(sqrt(RAM))
ram=$(grep MemTotal /proc/meminfo | awk '{ print int($2 / 1000000) }')
swap=$(echo "$ram" | awk '{ print $1 + int(sqrt(8)) }')

boot_partition=/dev/sda1
swap_partition=/dev/sda2
root_partition=/dev/sda3

packages="base linux linux-firmware grub efibootmgr networkmanager $cpu_package"

# ========== Functions ==========

infobox() {
	border_length=$(( "${#1}" + 2))
	printf "\n%${border_length}s\n" | tr " " "="
	echo " $1 "
	printf "%${border_length}s\n\n" | tr " " "="
}

check_variables() {
	valid_username=$(echo "$USER_NAME" | grep "^[a-z_][a-z0-9_-]*$" || echo "")
	keymaps=$(localectl list-keymaps | grep -E "^$KEYMAP$" || echo "")
	locales=$(grep -P "#[\S@]" /etc/locale.gen | sed -e s/#//g | cut -d " " -f 1 | grep "^$LOCALE$" || echo "")

	infobox "Fetching Arch mirror countries with reflector"
	mirror_list=$(reflector --list-countries | sed -E 's/  +/,/g' | cut -d "," -f 1 | sed 1,2d | grep -E "^$MIRROR_COUNTRY$" || echo "")

	clear

	if [ -z "$locales" ]; then
		infobox "The locale is invalid, check all valid locales with the command by checking the file: '/etc/locale.gen'"
		exit 1
	elif [ -z "$keymaps" ]; then
		infobox "The keyboard layout is invalid, check all valid keyboard layouts with the command: 'localectl list-keymaps'"
		exit 1
	elif [ -z "$mirror_list" ]; then
		infobox "The mirror country is invalid, check all valid mirror countries with the command: 'reflector --list-countries'"
		exit 1
	elif [ -z "$valid_username" ]; then
		infobox "Your username is invalid, remember to only use alfanumeric characters, and the first character MUST be a letter"
		exit 1
	elif [ -z "$ROOT_PASSWORD" ] || [ -z "$LUKS_PARTITION_NAME" ] || [ -z "$LUKS_PARTITION_PASSWORD" ]; then
		infobox "Check your configuration variables on the beginning of the 'arsh' file, maybe one of them is invalid or undefined"
		exit 1
	fi
}

welcome() {
	echo " Welcome to arsh! "
	echo "=================="
	echo "This script will automatically setup an LUKS encrypted Arch Linux installation on your system"
	echo "If you have any doubts about the installation process, i strongly recommend to installing this"
	printf "on a virtual machine first, once you start, there's no turning back, the whole process is automated\n\n"
	printf "%sWARNING: This means your whole disk will be wiped, deleting ALL your data%s\n\n" "$bold" "$normal"
	read -rp "Do you wanna start the installation? (y/n) " install
	if echo "$install" | grep -vE "^[yY]$"; then
		exit
	fi
}

partitioning() {
	infobox "Creating boot (/dev/sda1), swap (/dev/sda2), and root (/dev/sda3) partitions"
	boot_partition_create="n 1\n\n+550M"
	swap_partition_create="n 2\n\n+${swap}G"
	root_partition_create="n 3\n\n"

	boot_partition_type="t 1 1"
	swap_partition_type="t 2 19"

	fdisk_instructions="
		g
		$boot_partition_create
		$swap_partition_create
		$root_partition_create
		$boot_partition_type
		$swap_partition_type
		w
	"
	for instruction in $fdisk_instructions; do
		printf "%s" "$instruction\n"
	done | fdisk /dev/sda
}

formatting() {
	infobox "Formatting boot partition as FAT32"
	mkfs.fat -F32 $boot_partition

	infobox "Setting up swap partition"
	mkswap $swap_partition
	swapon $swap_partition

	infobox "Setting up LUKS encryption on root partition"
	printf "%s" "$LUKS_PARTITION_PASSWORD" | cryptsetup luksFormat -v $root_partition -d -

	infobox "Opens encrypted root partition in order to format it"
	printf "%s" "$LUKS_PARTITION_PASSWORD" | cryptsetup open $root_partition "$LUKS_PARTITION_NAME" -d -

	infobox "Formats root partition as ext4"
	mkfs.ext4 "/dev/mapper/$LUKS_PARTITION_NAME"

	infobox "Mount root partition to /mnt"
	mount "/dev/mapper/$LUKS_PARTITION_NAME" /mnt

	infobox "Mount boot partition to /mnt/boot"
	mkdir /mnt/boot
	mount $boot_partition /mnt/boot
}

mirrors() {
	# Get the most recently updated mirrors from the specified country
	reflector --sort age -c "$MIRROR_COUNTRY" --save /etc/pacman.d/mirrorlist
}

install_packages() {
	infobox "Initialize pacman keyring"
	pacman-key --init

	infobox "Verifying pacman keyring master keys"
	pacman-key --populate archlinux

	infobox "Synchronizing package databases"
	pacman -Sy

	infobox "Installing base system packages: $packages}"
	pacstrap /mnt $packages
}

generate_filesystem_table() {
	infobox "Generating filesystem table"
	genfstab -U /mnt >> /mnt/etc/fstab
}

bootloader() {
	sed -i "s/autodetect modconf/autodetect keyboard keymap modconf/" /mnt/etc/mkinitcpio.conf
	sed -i "s/modconf block/modconf block encrypt/" /mnt/etc/mkinitcpio.conf

	arch-chroot /mnt mkinitcpio -p linux

	infobox "Installing GRUB"
	arch-chroot /mnt grub-install --target=x86_64-efi --efi-directory=/boot --bootloader-id=GRUB

	infobox "Generating GRUB config file"
	arch-chroot /mnt grub-mkconfig -o /boot/grub/grub.cfg
	luks_partition_uuid=$(blkid -o value $root_partition | head -n 1)
	grub_old_string="GRUB_CMDLINE_LINUX=\"\""
	grub_kernel_parameters="cryptdevice=UUID=$luks_partition_uuid:$LUKS_PARTITION_NAME root=/dev/mapper/$LUKS_PARTITION_NAME"
	grub_new_string="GRUB_CMDLINE_LINUX=\"$grub_kernel_parameters\""
	sed -i "s|$grub_old_string|$grub_new_string|" /mnt/etc/default/grub
	arch-chroot /mnt grub-mkconfig -o /boot/grub/grub.cfg
}

keymap() {
	infobox "Saving persistent keyboard layout configuration"
	echo "KEYMAP=$KEYMAP" > /mnt/etc/vconsole.conf
}

locales() {
	infobox "Generating locales for '$LOCALE'"
	sed -i "s/#${LOCALE}/${LOCALE}/" /mnt/etc/locale.gen
	arch-chroot /mnt /bin/bash <<- EOF
		locale-gen
		echo "LANG=$LOCALE" | cut -d " " -f 1 > /mnt/etc/locale.conf
	EOF
}

root_password() {
	infobox "Setting root password"
	arch-chroot /mnt /bin/bash <<- EOF
		printf "$ROOT_PASSWORD\n$ROOT_PASSWORD" | passwd
	EOF
}

create_user() {
	infobox "Creating non-root user '$USER_NAME'"
	arch-chroot /mnt useradd -mG wheel,video,storage "$USER_NAME"
	arch-chroot /mnt /bin/bash <<- EOF
		printf "$USER_PASSWORD\n$USER_PASSWORD" | passwd $USER_NAME
	EOF
}

post_install() {
	infobox "Enabling NetworkManager service"
	arch-chroot /mnt systemctl enable NetworkManager

	infobox "Unmounting root partition from /mnt"
	umount -l /mnt

	infobox "Installation finished! you might remove the installation media and reboot now"
}

check_variables
welcome
partitioning
formatting
mirrors
install_packages
generate_filesystem_table
bootloader
keymap
locales
root_password
create_user
post_install
